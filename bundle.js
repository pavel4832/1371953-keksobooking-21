(()=>{"use strict";window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},isEnterEvent:(e,t)=>{"Enter"===e.key&&t()}},window.load=(e,t,o,r,n)=>{const d=new XMLHttpRequest;d.responseType="json",d.addEventListener("load",(()=>{200===d.status?o(d.response):r(`Статус ответа: ${d.status} ${d.statusText}`)})),d.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),d.addEventListener("timeout",(()=>{r(`Запрос не успел выполниться за ${d.timeout}мс`)})),d.timeout=1e4,d.open(t,e),n?d.send(n):d.send()},(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=()=>{const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")};window.pin={renderPins:r=>{const n=document.createDocumentFragment(),d=r.length>5?5:r.length;for(let e=0;e<d;e++){const d=t.cloneNode(!0);d.style=`left: ${r[e].location.x-25}px; top: ${r[e].location.y-70}px;`,d.querySelector("img").src=r[e].author.avatar,d.querySelector("img").alt=r[e].offer.title,n.appendChild(d),d.addEventListener("click",(()=>{o(),d.classList.add("map__pin--active"),window.map.showCard(r[e])}))}e.appendChild(n)},removePins:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((t=>{e.removeChild(t)}))}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),o={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},r=(e,t)=>{t?e.textContent=t:e.style.display="none"};window.renderCard=n=>{const d=document.createDocumentFragment(),s=document.querySelector(".map__filters-container"),i=t.cloneNode(!0),c=i.querySelector(".popup__features"),a=i.querySelectorAll(".popup__feature"),l=i.querySelector(".popup__photos"),u=i.querySelector(".popup__photo");var p,m;p=i.querySelector(".popup__avatar"),(m=n.author.avatar)?p.src=m:p.style.display="none",r(i.querySelector(".popup__title"),n.offer.title),r(i.querySelector(".popup__text--address"),n.offer.address),r(i.querySelector(".popup__text--price"),n.offer.price),r(i.querySelector(".popup__type"),o[n.offer.type]),((e,t,o)=>{const r=(e=>{let t;return t=1===e?"комната":5===e?"комнат":"комнаты",t})(t),n=(e=>{let t;return t=1===e?"гостя":"гостей",t})(o);t&&o?e.textContent=`${t} ${r} для ${o} ${n}`:e.style.display="none"})(i.querySelector(".popup__text--capacity"),n.offer.rooms,n.offer.guests),((e,t,o)=>{t&&o?e.textContent=`Заезд после ${t}, выезд до ${o}`:e.style.display="none"})(i.querySelector(".popup__text--time"),n.offer.checkin,n.offer.checkout),((e,t,o)=>{if(o){e.innerHTML="";for(let r=0;r<o.length;r++)for(let n=0;n<t.length;n++)t[n].classList.contains("popup__feature--"+o[r])&&e.appendChild(t[n])}else e.style.display="none"})(c,a,n.offer.features),r(i.querySelector(".popup__description"),n.offer.description),((e,t,o)=>{o?(e.innerHTML="",o.forEach((o=>{let r=t.cloneNode(!0);e.appendChild(r),r.src=o}))):e.style.display="none"})(l,u,n.offer.photos),d.appendChild(i),e.insertBefore(d,s)}})(),(()=>{const e=document.querySelector(".map"),t=e=>{"Escape"===e.key&&(e.preventDefault(),window.map.closeCard())};window.map={closeCard:()=>{const o=e.querySelector(".map__card");o&&(e.removeChild(o),document.removeEventListener("keydown",t))},showCard:o=>{let r=e.querySelector(".map__card");r&&e.removeChild(r),window.renderCard(o),r=e.querySelector(".map__card"),document.addEventListener("keydown",t),r.querySelector(".popup__close").addEventListener("click",(()=>{window.map.closeCard()})),r.querySelector(".popup__close").addEventListener("keydown",(e=>{"Enter"===e.key&&window.map.closeCard()}))}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("main"),o=document.querySelector(".map").querySelector(".map__pin--main"),r=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error"),d=document.querySelector(".ad-form"),s=d.querySelector("#avatar"),i=d.querySelector(".ad-form-header__preview img"),c=d.querySelector("#address"),a=d.querySelector("#type"),l=d.querySelector("#price"),u=d.querySelector("#timein"),p=d.querySelector("#timeout"),m=d.querySelector("#room_number"),y=d.querySelector("#capacity"),w=d.querySelector("#images"),f=d.querySelector(".ad-form__photo"),v={PALACE:"10000",FLAT:"1000",HOUSE:"5000",BUNGALOW:"0"};window.fillAddressField=(e,t)=>{const r=parseInt(o.style.left,10)+e,n=parseInt(o.style.top,10)+t;c.value=`${r}, ${n}`},window.checkValidGuest=()=>{const e=m.value,t=y.value;"100"===e&&"0"!==t?y.setCustomValidity("Это жилье не для гостей. Измените выбор"):"0"===t&&"100"!==e?y.setCustomValidity("Это жилье для размещения гостей. Измените выбор комнат"):e<t?y.setCustomValidity("Количество гостей превышает количество комнат. Уменьшите количество гостей"):y.setCustomValidity(""),y.reportValidity()};const _=(e,t)=>{const o=t.options;for(let e=0;e<o.length;e++)o[e].removeAttribute("selected");o[e.selectedIndex].setAttribute("selected","selected")},S=()=>{const e=t.querySelector(".error"),o=t.querySelector(".success");return e||o},q=e=>{window.util.isEscEvent(e,(()=>{g()}))},h=e=>{window.util.isEnterEvent(e,(()=>{g()}))},E=e=>{const t=S();e.preventDefault(),e.target===t&&g()},g=()=>{const e=S();t.removeChild(e),document.removeEventListener("keydown",q),document.removeEventListener("click",E)},L=()=>{const e=document.createDocumentFragment(),o=r.cloneNode(!0);e.appendChild(o),t.appendChild(e),document.addEventListener("keydown",q),document.addEventListener("click",E),window.deactivatePage()},k=()=>{const e=document.createDocumentFragment(),o=n.cloneNode(!0),r=o.querySelector(".error__button");e.appendChild(o),t.appendChild(e),r.addEventListener("click",g),r.addEventListener("keydown",h),document.addEventListener("keydown",q),document.addEventListener("click",E)},C=(t,o)=>{const r=t.target.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;o.src="",e.addEventListener("load",(e=>{o.src=e.target.result})),e.readAsDataURL(r)}};s.addEventListener("change",(e=>{C(e,i)})),a.addEventListener("change",(()=>{(()=>{const e=a.value,t=v[e.toUpperCase()];l.setAttribute("placeholder",t),l.setAttribute("min",t)})()})),u.addEventListener("change",(()=>{_(u,p)})),p.addEventListener("change",(()=>{_(p,u)})),y.addEventListener("change",(()=>{window.checkValidGuest()})),m.addEventListener("change",(()=>{window.checkValidGuest()})),w.addEventListener("change",(e=>{f.innerHTML="",f.appendChild((e=>{const t=document.createElement("img");return t.setAttribute("height","100%"),t.setAttribute("width","100%"),t.setAttribute("alt","Фотография жилья"),t.style.borderRadius="5px",C(e,t),t})(e))})),d.addEventListener("submit",(e=>{e.preventDefault(),window.load("https://21.javascript.pages.academy/keksobooking","POST",L,k,new FormData(d))}))})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=e.querySelector(".map__pin--main"),r=t.clientWidth-31;o.addEventListener("mousedown",(e=>{(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const n=e=>{let n=t.x-e.clientX,d=t.y-e.clientY,s={x:o.offsetLeft-n,y:o.offsetTop-d};var i;t={x:e.clientX,y:e.clientY},(i=s).x<=-31&&(i.x=-31),i.x>=r&&(i.x=r),i.y<=46&&(i.y=46),i.y>=546&&(i.y=546),o.style.top=s.y+"px",o.style.left=s.x+"px",window.fillAddressField(31,84)},d=e=>{e.preventDefault(),n(e)},s=e=>{e.preventDefault(),n(e),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",s)})(e)}))})(),window.debounce=e=>{let t=null;return(...o)=>{let r=o;t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...r)}),500)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),d=e.querySelectorAll("#housing-features input"),s=(e,t)=>"any"===t||String(e)===t,i=window.debounce((e=>{window.pin.removePins(),window.map.closeCard(),window.pin.renderPins((e=>{const i=t.value,c=o.value,a=r.value,l=n.value,u=(()=>{let e=[];return d.forEach((t=>{t.checked&&e.push(t.value)})),e})();return e.filter((e=>s(e.offer.type,i)&&((e,t)=>{let o;return"any"===t||(o=e<1e4?"low":e>=1e4&&e<=5e4?"middle":"high",o===t)})(e.offer.price,c)&&s(e.offer.rooms,a)&&s(e.offer.guests,l)&&((e,t)=>t.every((t=>-1!==e.offer.features.indexOf(t))))(e,u)))})(e))}));e.addEventListener("change",(()=>{i(window.pins)}))})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),r=document.querySelectorAll(".ad-form fieldset, .map__filters select, .map__filters fieldset"),n=document.querySelectorAll(".ad-form fieldset"),d=document.querySelectorAll(".map__filters select, .map__filters fieldset"),s=o.querySelector("#address"),i=document.querySelector(".ad-form__reset"),c=o.querySelector(".ad-form-header__preview img"),a=o.querySelector(".ad-form__photo");window.pins=[];const l=e=>{e.forEach((e=>{e.removeAttribute("disabled")}))},u=e=>{0===e.button&&f()},p=e=>{window.util.isEnterEvent(e,(()=>{f()}))},m=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},y=e=>{window.pins=e,window.pin.renderPins(e),l(d)},w=()=>{window.deactivatePage(),i.removeEventListener("click",w)},f=()=>{l(n),s.setAttribute("disabled","disabled"),e.classList.remove("map--faded"),o.classList.remove("ad-form--disabled"),window.fillAddressField(31,84),window.load("https://21.javascript.pages.academy/keksobooking/data","GET",y,m),t.removeEventListener("mousedown",u),t.removeEventListener("keydown",p),i.addEventListener("click",w)};window.deactivatePage=()=>{o.reset(),c.src="img/muffin-grey.svg",a.innerHTML="",r.forEach((e=>{e.setAttribute("disabled","disabled")})),window.fillAddressField(31,31),e.classList.add("map--faded"),o.classList.add("ad-form--disabled"),t.style.top="375px",t.style.left="570px",t.addEventListener("mousedown",u),t.addEventListener("keydown",p),window.pin.removePins(),window.map.closeCard()}})(),window.deactivatePage(),window.checkValidGuest(),window.scrollTo(0,0)})();