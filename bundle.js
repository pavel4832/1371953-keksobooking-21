(()=>{"use strict";window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},isEnterEvent:(e,t)=>{"Enter"===e.key&&t()}},window.load=(e,t,r,o,n)=>{const d=new XMLHttpRequest;d.responseType="json",d.addEventListener("load",(()=>{200===d.status?r(d.response):o(`Статус ответа: ${d.status} ${d.statusText}`)})),d.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),d.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${d.timeout}мс`)})),d.timeout=1e4,d.open(t,e),n?d.send(n):d.send()},(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),r=()=>{const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")};window.pin={renderPins:o=>{const n=document.createDocumentFragment(),d=o.length>5?5:o.length;for(let e=0;e<d;e++){const d=t.cloneNode(!0);d.style=`left: ${o[e].location.x-25}px; top: ${o[e].location.y-70}px;`,d.querySelector("img").src=o[e].author.avatar,d.querySelector("img").alt=o[e].offer.title,n.appendChild(d),d.addEventListener("click",(()=>{r(),d.classList.add("map__pin--active"),window.map.showCard(o[e])}))}e.appendChild(n)},removePins:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((t=>{e.removeChild(t)}))}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),r={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},o=(e,t)=>{t?e.textContent=t:e.style.display="none"};window.renderCard=n=>{const d=document.createDocumentFragment(),i=document.querySelector(".map__filters-container"),s=t.cloneNode(!0),a=s.querySelector(".popup__features"),c=s.querySelectorAll(".popup__feature"),l=s.querySelector(".popup__photos"),u=s.querySelector(".popup__photo");var p,m;p=s.querySelector(".popup__avatar"),(m=n.author.avatar)?p.src=m:p.style.display="none",o(s.querySelector(".popup__title"),n.offer.title),o(s.querySelector(".popup__text--address"),n.offer.address),o(s.querySelector(".popup__text--price"),n.offer.price),o(s.querySelector(".popup__type"),r[n.offer.type]),((e,t,r)=>{const o=(e=>{let t;return t=1===e?"комната":5===e?"комнат":"комнаты",t})(t),n=(e=>{let t;return t=1===e?"гостя":"гостей",t})(r);t&&r?e.textContent=`${t} ${o} для ${r} ${n}`:e.style.display="none"})(s.querySelector(".popup__text--capacity"),n.offer.rooms,n.offer.guests),((e,t,r)=>{t&&r?e.textContent=`Заезд после ${t}, выезд до ${r}`:e.style.display="none"})(s.querySelector(".popup__text--time"),n.offer.checkin,n.offer.checkout),((e,t,r)=>{if(r){e.innerHTML="";for(let o=0;o<r.length;o++)for(let n=0;n<t.length;n++)t[n].classList.contains("popup__feature--"+r[o])&&e.appendChild(t[n])}else e.style.display="none"})(a,c,n.offer.features),o(s.querySelector(".popup__description"),n.offer.description),((e,t,r)=>{r?(e.innerHTML="",r.forEach((r=>{let o=t.cloneNode(!0);e.appendChild(o),o.src=r}))):e.style.display="none"})(l,u,n.offer.photos),d.appendChild(s),e.insertBefore(d,i)}})(),(()=>{const e=document.querySelector(".map"),t=e=>{"Escape"===e.key&&(e.preventDefault(),window.map.closeCard())};window.map={closeCard:()=>{const r=e.querySelector(".map__card");r&&(e.removeChild(r),document.removeEventListener("keydown",t))},showCard:r=>{let o=e.querySelector(".map__card");o&&e.removeChild(o),window.renderCard(r),o=e.querySelector(".map__card"),document.addEventListener("keydown",t),o.querySelector(".popup__close").addEventListener("click",(()=>{window.map.closeCard()})),o.querySelector(".popup__close").addEventListener("keydown",(e=>{"Enter"===e.key&&window.map.closeCard()}))}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("main"),r=document.querySelector(".map").querySelector(".map__pin--main"),o=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error"),d=document.querySelector(".ad-form"),i=d.querySelector("#avatar"),s=d.querySelector(".ad-form-header__preview img"),a=d.querySelector("#address"),c=d.querySelector("#type"),l=d.querySelector("#price"),u=d.querySelector("#timein"),p=d.querySelector("#timeout"),m=d.querySelector("#room_number"),y=d.querySelector("#capacity"),w=d.querySelector("#images"),f=d.querySelector(".ad-form__photo"),v={PALACE:"10000",FLAT:"1000",HOUSE:"5000",BUNGALOW:"0"};window.fillAddressField=(e,t)=>{const o=parseInt(r.style.left,10)+e,n=parseInt(r.style.top,10)+t;a.value=`${o}, ${n}`},window.checkValidGuest=()=>{const e=m.value,t=y.value;"100"===e&&"0"!==t?y.setCustomValidity("Это жилье не для гостей. Измените выбор"):"0"===t&&"100"!==e?y.setCustomValidity("Это жилье для размещения гостей. Измените выбор комнат"):e<t?y.setCustomValidity("Количество гостей превышает количество комнат. Уменьшите количество гостей"):y.setCustomValidity(""),y.reportValidity()};const _=()=>{const e=t.querySelector(".error"),r=t.querySelector(".success");return e||r},S=e=>{window.util.isEscEvent(e,(()=>{E()}))},q=e=>{window.util.isEnterEvent(e,(()=>{E()}))},h=e=>{const t=_();e.preventDefault(),e.target===t&&E()},E=()=>{const e=_();t.removeChild(e),document.removeEventListener("keydown",S),document.removeEventListener("click",h)},g=()=>{const e=document.createDocumentFragment(),r=o.cloneNode(!0);e.appendChild(r),t.appendChild(e),document.addEventListener("keydown",S),document.addEventListener("click",h),window.deactivatePage()},L=()=>{const e=document.createDocumentFragment(),r=n.cloneNode(!0),o=r.querySelector(".error__button");e.appendChild(r),t.appendChild(e),o.addEventListener("click",E),o.addEventListener("keydown",q),document.addEventListener("keydown",S),document.addEventListener("click",h)},k=(t,r)=>{const o=t.target.files[0],n=o.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;r.src="",e.addEventListener("load",(e=>{r.src=e.target.result})),e.readAsDataURL(o)}};i.addEventListener("change",(e=>{k(e,s)})),c.addEventListener("change",(()=>{(()=>{const e=c.value,t=v[e.toUpperCase()];l.setAttribute("placeholder",t),l.setAttribute("min",t)})()})),u.addEventListener("change",(()=>{p.value=u.value})),p.addEventListener("change",(()=>{u.value=p.value})),y.addEventListener("change",(()=>{window.checkValidGuest()})),m.addEventListener("change",(()=>{window.checkValidGuest()})),w.addEventListener("change",(e=>{f.innerHTML="",f.appendChild((e=>{const t=document.createElement("img");return t.setAttribute("height","100%"),t.setAttribute("width","100%"),t.setAttribute("alt","Фотография жилья"),t.style.borderRadius="5px",k(e,t),t})(e))})),d.addEventListener("submit",(e=>{e.preventDefault(),window.load("https://21.javascript.pages.academy/keksobooking","POST",g,L,new FormData(d))}))})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),r=e.querySelector(".map__pin--main"),o=t.clientWidth-31;r.addEventListener("mousedown",(e=>{(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const n=e=>{let n=t.x-e.clientX,d=t.y-e.clientY,i={x:r.offsetLeft-n,y:r.offsetTop-d};var s;t={x:e.clientX,y:e.clientY},(s=i).x<=-31&&(s.x=-31),s.x>=o&&(s.x=o),s.y<=46&&(s.y=46),s.y>=546&&(s.y=546),r.style.top=i.y+"px",r.style.left=i.x+"px",window.fillAddressField(31,84)},d=e=>{e.preventDefault(),n(e)},i=e=>{e.preventDefault(),n(e),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",i)})(e)}))})(),window.debounce=e=>{let t=null;return(...r)=>{let o=r;t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),r=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),d=e.querySelectorAll("#housing-features input"),i=(e,t)=>"any"===t||String(e)===t,s=window.debounce((e=>{window.pin.removePins(),window.map.closeCard(),window.pin.renderPins((e=>{const s=t.value,a=r.value,c=o.value,l=n.value,u=(()=>{let e=[];return d.forEach((t=>{t.checked&&e.push(t.value)})),e})();return e.filter((e=>i(e.offer.type,s)&&((e,t)=>{let r;return"any"===t||(r=e<1e4?"low":e>=1e4&&e<=5e4?"middle":"high",r===t)})(e.offer.price,a)&&i(e.offer.rooms,c)&&i(e.offer.guests,l)&&((e,t)=>t.every((t=>-1!==e.offer.features.indexOf(t))))(e,u)))})(e))}));e.addEventListener("change",(()=>{s(window.pins)}))})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),r=document.querySelector(".ad-form"),o=document.querySelectorAll(".ad-form fieldset, .map__filters select, .map__filters fieldset"),n=document.querySelectorAll(".ad-form fieldset"),d=document.querySelectorAll(".map__filters select, .map__filters fieldset"),i=r.querySelector("#address"),s=document.querySelector(".ad-form__reset"),a=r.querySelector(".ad-form-header__preview img"),c=r.querySelector(".ad-form__photo");window.pins=[];const l=e=>{e.forEach((e=>{e.removeAttribute("disabled")}))},u=e=>{0===e.button&&f()},p=e=>{window.util.isEnterEvent(e,(()=>{f()}))},m=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},y=e=>{window.pins=e,window.pin.renderPins(e),l(d)},w=()=>{window.deactivatePage(),s.removeEventListener("click",w)},f=()=>{l(n),i.setAttribute("disabled","disabled"),e.classList.remove("map--faded"),r.classList.remove("ad-form--disabled"),window.fillAddressField(31,84),window.load("https://21.javascript.pages.academy/keksobooking/data","GET",y,m),t.removeEventListener("mousedown",u),t.removeEventListener("keydown",p),s.addEventListener("click",w)};window.deactivatePage=()=>{r.reset(),a.src="img/muffin-grey.svg",c.innerHTML="",o.forEach((e=>{e.setAttribute("disabled","disabled")})),window.fillAddressField(31,31),e.classList.add("map--faded"),r.classList.add("ad-form--disabled"),t.addEventListener("mousedown",u),t.addEventListener("keydown",p),window.pin.removePins(),window.map.closeCard()}})(),window.deactivatePage(),window.checkValidGuest(),window.scrollTo(0,0)})();