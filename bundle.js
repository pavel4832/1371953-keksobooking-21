(()=>{"use strict";window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},isEnterEvent:(e,t)=>{"Enter"===e.key&&t()}},window.load=(e,t,o,r,n)=>{const d=new XMLHttpRequest;d.responseType="json",d.addEventListener("load",(()=>{200===d.status?o(d.response):r(`Статус ответа: ${d.status} ${d.statusText}`)})),d.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),d.addEventListener("timeout",(()=>{r(`Запрос не успел выполниться за ${d.timeout}мс`)})),d.timeout=1e4,d.open(t,e),n?d.send(n):d.send()},(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=()=>{const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")};window.pin={renderPins:r=>{const n=document.createDocumentFragment(),d=r.length>5?5:r.length;for(let e=0;e<d;e++){const d=t.cloneNode(!0);d.style=`left: ${r[e].location.x-25}px; top: ${r[e].location.y-70}px;`,d.querySelector("img").src=r[e].author.avatar,d.querySelector("img").alt=r[e].offer.title,n.appendChild(d),d.addEventListener("click",(()=>{o(),d.classList.add("map__pin--active"),window.map.showCard(r[e])}))}e.appendChild(n)},removePins:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((t=>{e.removeChild(t)}))}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),o={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},r=(e,t)=>{t?e.textContent=t:e.style.display="none"};window.renderCard=n=>{const d=document.createDocumentFragment(),i=document.querySelector(".map__filters-container"),a=t.cloneNode(!0),s=a.querySelector(".popup__features"),c=a.querySelectorAll(".popup__feature"),l=a.querySelector(".popup__photos"),u=a.querySelector(".popup__photo");var p,m;p=a.querySelector(".popup__avatar"),(m=n.author.avatar)?p.src=m:p.style.display="none",r(a.querySelector(".popup__title"),n.offer.title),r(a.querySelector(".popup__text--address"),n.offer.address),r(a.querySelector(".popup__text--price"),n.offer.price),r(a.querySelector(".popup__type"),o[n.offer.type]),((e,t,o)=>{const r=(e=>1===e?"комната":5===e?"комнат":"комнаты")(t),n=(e=>1===e?"гостя":"гостей")(o);t&&o?e.textContent=`${t} ${r} для ${o} ${n}`:e.style.display="none"})(a.querySelector(".popup__text--capacity"),n.offer.rooms,n.offer.guests),((e,t,o)=>{t&&o?e.textContent=`Заезд после ${t}, выезд до ${o}`:e.style.display="none"})(a.querySelector(".popup__text--time"),n.offer.checkin,n.offer.checkout),((e,t,o)=>{if(o){e.innerHTML="";for(let r=0;r<o.length;r++)for(let n=0;n<t.length;n++)t[n].classList.contains("popup__feature--"+o[r])&&e.appendChild(t[n])}else e.style.display="none"})(s,c,n.offer.features),r(a.querySelector(".popup__description"),n.offer.description),((e,t,o)=>{o?(e.innerHTML="",o.forEach((o=>{let r=t.cloneNode(!0);e.appendChild(r),r.src=o}))):e.style.display="none"})(l,u,n.offer.photos),d.appendChild(a),e.insertBefore(d,i)}})(),(()=>{const e=document.querySelector(".map"),t=e=>{"Escape"===e.key&&(e.preventDefault(),window.map.closeCard())};window.map={closeCard:()=>{const o=e.querySelector(".map__card");o&&(e.removeChild(o),document.removeEventListener("keydown",t))},showCard:o=>{let r=e.querySelector(".map__card");r&&e.removeChild(r),window.renderCard(o),r=e.querySelector(".map__card"),document.addEventListener("keydown",t),r.querySelector(".popup__close").addEventListener("click",(()=>{window.map.closeCard()})),r.querySelector(".popup__close").addEventListener("keydown",(e=>{"Enter"===e.key&&window.map.closeCard()}))}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("main"),o=document.querySelector(".map").querySelector(".map__pin--main"),r=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error"),d=document.querySelector(".ad-form"),i=d.querySelector("#avatar"),a=d.querySelector(".ad-form-header__preview img"),s=d.querySelector("#address"),c=d.querySelector("#type"),l=d.querySelector("#price"),u=d.querySelector("#timein"),p=d.querySelector("#timeout"),m=d.querySelector("#room_number"),y=d.querySelector("#capacity"),f=d.querySelector("#images"),v=d.querySelector(".ad-form__photo"),w={PALACE:"10000",FLAT:"1000",HOUSE:"5000",BUNGALOW:"0"};window.form={fillAddressField:(e,t)=>{const r=parseInt(o.style.left,10)+e,n=parseInt(o.style.top,10)+t;s.value=`${r}, ${n}`},checkValidGuest:()=>{const e=m.value,t=y.value;"100"===e&&"0"!==t?y.setCustomValidity("Это жилье не для гостей. Измените выбор"):"0"===t&&"100"!==e?y.setCustomValidity("Это жилье для размещения гостей. Измените выбор комнат"):e<t?y.setCustomValidity("Количество гостей превышает количество комнат. Уменьшите количество гостей"):y.setCustomValidity(""),y.reportValidity()}};const _=()=>{const e=t.querySelector(".error"),o=t.querySelector(".success");return e||o},S=e=>{window.util.isEscEvent(e,(()=>{E()}))},q=e=>{window.util.isEnterEvent(e,(()=>{E()}))},h=e=>{const t=_();e.preventDefault(),e.target===t&&E()},E=()=>{const e=_();t.removeChild(e),document.removeEventListener("keydown",S),document.removeEventListener("click",h)},g=()=>{const e=document.createDocumentFragment(),o=r.cloneNode(!0);e.appendChild(o),t.appendChild(e),document.addEventListener("keydown",S),document.addEventListener("click",h),window.deactivatePage()},L=()=>{const e=document.createDocumentFragment(),o=n.cloneNode(!0),r=o.querySelector(".error__button");e.appendChild(o),t.appendChild(e),r.addEventListener("click",E),r.addEventListener("keydown",q),document.addEventListener("keydown",S),document.addEventListener("click",h)},k=(t,o)=>{const r=t.target.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;o.src="",e.addEventListener("load",(e=>{o.src=e.target.result})),e.readAsDataURL(r)}};i.addEventListener("change",(e=>{k(e,a)})),c.addEventListener("change",(()=>{(()=>{const e=c.value,t=w[e.toUpperCase()];l.setAttribute("placeholder",t),l.setAttribute("min",t)})()})),u.addEventListener("change",(()=>{p.value=u.value})),p.addEventListener("change",(()=>{u.value=p.value})),y.addEventListener("change",(()=>{window.form.checkValidGuest()})),m.addEventListener("change",(()=>{window.form.checkValidGuest()})),f.addEventListener("change",(e=>{v.innerHTML="",v.appendChild((e=>{const t=document.createElement("img");return t.setAttribute("height","100%"),t.setAttribute("width","100%"),t.setAttribute("alt","Фотография жилья"),t.style.borderRadius="5px",k(e,t),t})(e))})),d.addEventListener("submit",(e=>{e.preventDefault(),window.load("https://21.javascript.pages.academy/keksobooking","POST",g,L,new FormData(d))}))})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=e.querySelector(".map__pin--main"),r=t.clientWidth-31;o.addEventListener("mousedown",(e=>{(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const n=e=>{let n=t.x-e.clientX,d=t.y-e.clientY,i={x:o.offsetLeft-n,y:o.offsetTop-d};var a;t={x:e.clientX,y:e.clientY},(a=i).x<=-31&&(a.x=-31),a.x>=r&&(a.x=r),a.y<=46&&(a.y=46),a.y>=546&&(a.y=546),o.style.top=i.y+"px",o.style.left=i.x+"px",window.form.fillAddressField(31,84)},d=e=>{e.preventDefault(),n(e)},i=e=>{e.preventDefault(),n(e),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",i)})(e)}))})(),window.debounce=e=>{let t=null;return(...o)=>{let r=o;t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...r)}),500)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),d=e.querySelectorAll("#housing-features input"),i=(e,t)=>"any"===t||String(e)===t,a=window.debounce((e=>{window.pin.removePins(),window.map.closeCard(),window.pin.renderPins((e=>{const a=t.value,s=o.value,c=r.value,l=n.value,u=(()=>{let e=[];return d.forEach((t=>{t.checked&&e.push(t.value)})),e})();return e.filter((e=>i(e.offer.type,a)&&((e,t)=>{let o;return"any"===t||(o=e<1e4?"low":e>=1e4&&e<=5e4?"middle":"high",o===t)})(e.offer.price,s)&&i(e.offer.rooms,c)&&i(e.offer.guests,l)&&((e,t)=>t.every((t=>-1!==e.offer.features.indexOf(t))))(e,u)))})(e))}));e.addEventListener("change",(()=>{a(window.pins)}))})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),r=document.querySelectorAll(".ad-form fieldset, .map__filters select, .map__filters fieldset"),n=document.querySelectorAll(".ad-form fieldset"),d=document.querySelectorAll(".map__filters select, .map__filters fieldset"),i=document.querySelector(".ad-form__reset"),a=o.querySelector(".ad-form-header__preview img"),s=o.querySelector(".ad-form__photo");window.pins=[];const c=e=>{e.forEach((e=>{e.removeAttribute("disabled")}))},l=e=>{0===e.button&&f()},u=e=>{window.util.isEnterEvent(e,(()=>{f()}))},p=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},m=e=>{window.pins=e,window.pin.renderPins(e),c(d)},y=()=>{window.deactivatePage(),i.removeEventListener("click",y)},f=()=>{c(n),e.classList.remove("map--faded"),o.classList.remove("ad-form--disabled"),window.form.fillAddressField(31,84),window.load("https://21.javascript.pages.academy/keksobooking/data","GET",m,p),t.removeEventListener("mousedown",l),t.removeEventListener("keydown",u),i.addEventListener("click",y)};window.deactivatePage=()=>{o.reset(),a.src="img/muffin-grey.svg",s.innerHTML="",r.forEach((e=>{e.setAttribute("disabled","disabled")})),window.form.fillAddressField(31,31),e.classList.add("map--faded"),o.classList.add("ad-form--disabled"),t.addEventListener("mousedown",l),t.addEventListener("keydown",u),window.pin.removePins(),window.map.closeCard()}})(),window.deactivatePage(),window.form.checkValidGuest()})();